<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://fiorenzofdt.com/wp-content/uploads/fiorenzo-digital-teamwear.jpg">
  <title>FDT | Contabilizzatore</title>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <div class="container">
    <img src="./FDT.png" class="image-container">
    <br><br><br>

    <input type="file" id="fileInput" accept=".xls">
<br><br>
    <label for="fileFormat">Seleziona il formato di esportazione:</label>
    <select id="fileFormat">
      <option value="xls">XLS</option>
      <option value="csv">CSV</option>
    </select>

    <button class="buttonC" onclick="processFile()">Estrai colonne</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    console.log('version 17.07.1540');

    function processFile() {
      const uniqueNumbers = [];

      // Ottiene il file selezionato dall'input
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      // Crea un oggetto FileReader per leggere il contenuto del file
      const reader = new FileReader();

      // Funzione chiamata quando la lettura del file è completata
      reader.onload = function (e) {
        // Ottiene il contenuto del file XLS
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        // Ottiene il primo foglio di lavoro
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];

        // Converte il foglio di lavoro in formato CSV
        const csv = XLSX.utils.sheet_to_csv(worksheet);

        // Utilizza la libreria PapaParse per analizzare il CSV
        Papa.parse(csv, {
          complete: function (results) {
            // Array contenente gli indici delle colonne da estrarre
            const selectedColumns = [8, 9, 10, 11, 12, 4, 6, 5, 21, 17, 20, 15, 14];
            const outputData = [];

            // Aggiungi riga vuota
            outputData.push([]);

            // Itera tutte le righe del CSV
            results.data.forEach((row, rowIndex) => {
              const column5Value = row[5];

              // Se il numero è già presente nell'array uniqueNumbers, salta la riga corrente
              if (uniqueNumbers.includes(column5Value)) {
                return;
              }

              // Aggiunge il numero all'array uniqueNumbers
              uniqueNumbers.push(column5Value);
            });

            // Sposta tutte le righe di 1 in basso
            for (let i = results.data.length - 1; i > 0; i--) {
              results.data[i] = results.data[i - 1];
            }

            // Rinomina la prima riga
            results.data[0] = ['vabrsd', 'vabind', 'vabcad', 'vablod', 'vabprd', 'vabrmn', 'vabtic', 'vabcas', 'vabpkb', 'vabcbo', 'vabncl', 'vabemd', 'vabtrc'];

            // Itera tutte le righe del CSV
            results.data.forEach((row, rowIndex) => {
              const column5Value = row[5];
              const column6Value = row[6];
              const columnBEValue = row[17]; // Indice della colonna "BE" (contando da 0)

              // Se il numero è già stato filtrato, salta la riga corrente
              if (!uniqueNumbers.includes(column5Value) || !(row[0].includes("BRT"))) {
                return;
              }

              const rowData = [];

selectedColumns.forEach(columnIndex => {
  let cellValue = row[columnIndex] || '';
  if (columnIndex === 20 || columnIndex === 21) {
    cellValue = parseInt(cellValue, 10);
  }
  rowData.push(cellValue);
});


              // Aggiunge i valori delle colonne 50 e 83 solo se nella colonna 50 è presente "CONTRASSEGNO"
              if (rowIndex !== 0) {
                if (column6Value === "CONTRASSEGNO") {
                  rowData[6] = 'TP';
                  rowData[7] = row[5];
                  if (columnBEValue === "FRANCO") {
                    rowData[9] = 4;
                  } else if (columnBEValue === "ASSEGNATO") {
                    rowData[9] = 6;
                  }
                }
                else if (columnBEValue === "FRANCO") {
                  rowData[9] = 1;
                  rowData[6] = '';
                  rowData[7] = '';
                } else if (columnBEValue === "ASSEGNATO") {
                  rowData[9] = 2;
                  rowData[6] = '';
                  rowData[7] = '';
                }
              } else {
                rowData[6] = column6Value;
                rowData[7] = row[5];
              }

              // Aggiunge i valori estratti all'array dei dati di output
              outputData.push(rowData);

              // Rimuove il numero dall'array uniqueNumbers per evitare duplicati successivi
              uniqueNumbers.splice(uniqueNumbers.indexOf(column5Value), 1);

              outputData[0] = ['vabrsd', 'vabind', 'vabcad', 'vablod', 'vabprd', 'vabrmn', 'vabtic', 'vabcas', 'vabpkb', 'vabcbo', 'vabncl', 'vabemd', 'vabtrc'];
            });

            // Ottiene il formato di esportazione selezionato
            const exportFormat = document.getElementById('fileFormat').value;

            if (exportFormat === 'xls') {
              // Converti l'array dei dati di output in un oggetto Workbook
              const outputWorkbook = XLSX.utils.book_new();
              const outputWorksheet = XLSX.utils.aoa_to_sheet(outputData);
              XLSX.utils.book_append_sheet(outputWorkbook, outputWorksheet, 'Sheet 1');

              // Salva il file XLS
              const outputBuffer = XLSX.write(outputWorkbook, { type: 'array', bookType: 'xls' });
              saveFile(outputBuffer, 'output.xls');
            } else if (exportFormat === 'csv') {
              // Converti l'array dei dati di output in formato CSV
              const csvContent = Papa.unparse(outputData);

              // Salva il file CSV
              saveFile(csvContent, 'output.csv');
            }
          }
        });
      };

      // Legge il contenuto del file come array di byte
      reader.readAsArrayBuffer(file);
    }

    function saveFile(content, fileName) {
      // Crea un oggetto Blob contenente il contenuto del file
      if (navigator.msSaveBlob) { // Se il browser supporta il metodo msSaveBlob (Internet Explorer)
        navigator.msSaveBlob(new Blob([content]), fileName); // Salva il file usando msSaveBlob
      } else {
        // Altrimenti, crea un link temporaneo per il download del file
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([content]));
        link.setAttribute('download', fileName);

        // Aggiunge il link al documento, lo attiva e lo rimuove successivamente
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }
  </script>
</body>

</html>
